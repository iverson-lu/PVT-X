<Page x:Class="PcTest.Ui.Views.Pages.PlanPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
      xmlns:vm="clr-namespace:PcTest.Ui.ViewModels"
      xmlns:local="clr-namespace:PcTest.Ui.Views.Controls"
      Title="Plan"
      d:DataContext="{d:DesignInstance vm:PlanViewModel}"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      mc:Ignorable="d"
      Background="{DynamicResource SurfaceBackgroundBrush}">
    
    <Grid Margin="16">
        <TabControl x:Name="MainTabControl"
                    SelectedIndex="{Binding SelectedTabIndex}"
                    Style="{StaticResource SegmentedControlTabControl}">
            <!-- Cases Tab -->
            <TabItem Header="Cases" Style="{StaticResource SegmentedControlTabItem}">
                <Grid Margin="0,6,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="380" MinWidth="300"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*" MinWidth="300"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Cases List Card -->
                    <Border Grid.Column="0" 
                            Background="{DynamicResource CardBackgroundBrush}"
                            CornerRadius="{StaticResource RadiusM}"
                            BorderBrush="{DynamicResource CardBorderBrush}"
                            BorderThickness="1">
                        <Border.Effect>
                            <DropShadowEffect Color="{DynamicResource ShadowColor}" BlurRadius="20" ShadowDepth="3" Direction="270" Opacity="0.1"/>
                        </Border.Effect>
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Card Header -->
                            <TextBlock Grid.Row="0" 
                                      Text="Test Cases" 
                                      Style="{StaticResource SectionTitleStyle}"
                                      Margin="20,20,20,0"/>
                            
                            <!-- Action Buttons -->
                            <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="20,16,20,0">
                                <ui:Button Content="Discover" 
                                          Icon="{ui:SymbolIcon ArrowSync24}"
                                          Command="{Binding CasesTab.DiscoverCommand}"
                                          IsEnabled="{Binding CasesTab.IsDiscovering, Converter={StaticResource InverseBoolConverter}}"
                                          Margin="0,0,8,0"/>
                                <ui:Button Content="Import"
                                          Icon="{ui:SymbolIcon ArrowDownload24}"
                                          Command="{Binding CasesTab.ImportCommand}"
                                          Margin="0,0,8,0"/>
                                <ui:Button 
                                          Icon="{ui:SymbolIcon FolderOpen24}" 
                                          Command="{Binding CasesTab.OpenInExplorerCommand}"
                                          ToolTip="Open Folder"/>
                            </StackPanel>
                            
                            <!-- Search and Filter Row -->
                            <Grid Grid.Row="2" Margin="20,16,20,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="8"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Search Box -->
                                <ui:TextBox Grid.Column="0"
                                           PlaceholderText="Search cases..." 
                                           Text="{Binding CasesTab.SearchText, UpdateSourceTrigger=PropertyChanged}"
                                           Icon="{ui:SymbolIcon Search24}"/>
                                
                                <!-- Filter Chip (Latest Version) -->
                                <ToggleButton Grid.Column="2"
                                             IsChecked="{Binding CasesTab.ShowLatestVersionOnly}"
                                             Height="28"
                                             Padding="9,0,10,0"
                                             ToolTip="Show only the latest version of each test case">
                                    <ToggleButton.Style>
                                        <Style TargetType="ToggleButton">
                                            <Setter Property="Background" Value="Transparent"/>
                                            <Setter Property="BorderBrush" Value="{DynamicResource ControlStrokeColorDefaultBrush}"/>
                                            <Setter Property="BorderThickness" Value="1"/>
                                            <Setter Property="Foreground" Value="{DynamicResource TextFillColorTertiaryBrush}"/>
                                            <Setter Property="FontSize" Value="12"/>
                                            <Setter Property="FontWeight" Value="Normal"/>
                                            <Setter Property="Cursor" Value="Hand"/>
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="ToggleButton">
                                                        <Border x:Name="border"
                                                               Background="{TemplateBinding Background}"
                                                               BorderBrush="{TemplateBinding BorderBrush}"
                                                               BorderThickness="{TemplateBinding BorderThickness}"
                                                               CornerRadius="14"
                                                               Padding="{TemplateBinding Padding}">
                                                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                                                                <TextBlock x:Name="checkmark" 
                                                                          Text="●" 
                                                                          FontSize="8" 
                                                                          Margin="0,0,5,0"
                                                                          Visibility="Collapsed"
                                                                          VerticalAlignment="Center"
                                                                          Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"/>
                                                                <ContentPresenter VerticalAlignment="Center"/>
                                                            </StackPanel>
                                                        </Border>
                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter TargetName="border" Property="Background" Value="{DynamicResource SubtleFillColorSecondaryBrush}"/>
                                                                <Setter TargetName="border" Property="BorderBrush" Value="{DynamicResource ControlStrokeColorSecondaryBrush}"/>
                                                                <Setter Property="Foreground" Value="{DynamicResource TextFillColorSecondaryBrush}"/>
                                                            </Trigger>
                                                            <Trigger Property="IsChecked" Value="True">
                                                                <Setter Property="Background" Value="{DynamicResource ControlFillColorDefaultBrush}"/>
                                                                <Setter Property="BorderBrush" Value="{DynamicResource ControlStrokeColorDefaultBrush}"/>
                                                                <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}"/>
                                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                                                <Setter TargetName="checkmark" Property="Visibility" Value="Visible"/>
                                                            </Trigger>
                                                            <MultiTrigger>
                                                                <MultiTrigger.Conditions>
                                                                    <Condition Property="IsMouseOver" Value="True"/>
                                                                    <Condition Property="IsChecked" Value="True"/>
                                                                </MultiTrigger.Conditions>
                                                                <Setter Property="Background" Value="{DynamicResource ControlFillColorSecondaryBrush}"/>
                                                                <Setter Property="BorderBrush" Value="{DynamicResource ControlStrokeColorSecondaryBrush}"/>
                                                            </MultiTrigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </ToggleButton.Style>
                                    <TextBlock Text="Latest" FontSize="12"/>
                                </ToggleButton>
                            </Grid>
                            
                            <!-- Cases List -->
                            <ListBox x:Name="CasesListBox"
                                    Grid.Row="3" 
                                    ItemsSource="{Binding CasesTab.Cases}"
                                    SelectedItem="{Binding CasesTab.SelectedCase}"
                                    BorderThickness="0"
                                    Background="Transparent"
                                    VirtualizingPanel.IsVirtualizing="True"
                                    VirtualizingPanel.VirtualizationMode="Recycling"
                                    ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                    Padding="8,0,4,0">
                                <ListBox.ItemContainerStyle>
                                    <Style TargetType="ListBoxItem">
                                        <Setter Property="Padding" Value="20,10,16,10"/>
                                        <Setter Property="Margin" Value="2,0,12,2"/>
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Setter Property="BorderThickness" Value="0"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="ListBoxItem">
                                                    <Border Background="{TemplateBinding Background}"
                                                           BorderBrush="{TemplateBinding BorderBrush}"
                                                           BorderThickness="{TemplateBinding BorderThickness}"
                                                           Padding="{TemplateBinding Padding}"
                                                           CornerRadius="6">
                                                        <ContentPresenter/>
                                                    </Border>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="{DynamicResource InteractiveHoverBrush}"/>
                                            </Trigger>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter Property="Background" Value="{DynamicResource InteractiveSelectedBrush}"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </ListBox.ItemContainerStyle>
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            <StackPanel Grid.Row="0" Orientation="Horizontal">
                                                <TextBlock Text="{Binding Name}" 
                                                          FontWeight="{StaticResource FontWeightSemiBold}"
                                                          FontSize="{StaticResource FontSizeM}"
                                                          Foreground="{DynamicResource TextPrimaryBrush}"
                                                          TextTrimming="CharacterEllipsis"/>
                                                <ui:SymbolIcon Symbol="Shield24"
                                                              Foreground="#2F6FED"
                                                              Filled="True"
                                                              ToolTip="Administrator required"
                                                              Margin="6,0,0,0"
                                                              Visibility="{Binding IsAdminRequired, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                <ui:SymbolIcon Symbol="Shield24"
                                                              Foreground="#2F6FED"
                                                              ToolTip="Administrator recommended"
                                                              Margin="6,0,0,0"
                                                              Visibility="{Binding IsAdminPreferred, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                            </StackPanel>
                                            <TextBlock Grid.Row="1"
                                                      Text="{Binding Identity}" 
                                                      Foreground="{DynamicResource TextSecondaryBrush}" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Margin="0,2,0,0"
                                                      TextTrimming="CharacterEllipsis"/>
                                            <TextBlock Grid.Row="2"
                                                      Text="{Binding Category}" 
                                                      Foreground="{DynamicResource TextTertiaryBrush}" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Margin="0,2,0,0"
                                                      TextTrimming="CharacterEllipsis"/>
                                        </Grid>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Grid>
                    </Border>
                    
                    <!-- Splitter -->
                    <GridSplitter Grid.Column="1" 
                                 Width="16" 
                                 HorizontalAlignment="Stretch" 
                                 Background="Transparent"
                                 ShowsPreview="False"/>
                    
                    <!-- Case Details Card -->
                    <Border Grid.Column="2"
                            Background="{DynamicResource CardBackgroundBrush}"
                            CornerRadius="{StaticResource RadiusM}"
                            BorderBrush="{DynamicResource CardBorderBrush}"
                            BorderThickness="1">
                        <Border.Effect>
                            <DropShadowEffect Color="{DynamicResource ShadowColor}" BlurRadius="20" ShadowDepth="3" Direction="270" Opacity="0.1"/>
                        </Border.Effect>
                        <Grid DataContext="{Binding CasesTab.SelectedCase}">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Header -->
                            <Grid Grid.Row="0" Margin="24,24,24,16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Test Case Details"
                                          Style="{StaticResource SectionTitleStyle}"
                                          Margin="0"/>
                                <StackPanel Grid.Column="1" Orientation="Horizontal">
                                    <ui:Button Content="Run" 
                                              Icon="{ui:SymbolIcon Play24}" 
                                              Command="{Binding DataContext.CasesTab.RunCommand, RelativeSource={RelativeSource AncestorType=Page}}" 
                                              Appearance="Primary"/>
                                </StackPanel>
                            </Grid>
                            
                            <!-- Scrollable Content -->
                            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="24,0,24,24">
                                <StackPanel>
                                
                                <ui:CardExpander Header="Basic Information" 
                                                IsExpanded="True" 
                                                Margin="0,0,0,16">
                                    <StackPanel>
                                        <!-- Read-only view -->
                                        <Grid Visibility="{Binding IsEditing, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="110"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            
                                            <!-- Name Row -->
                                            <TextBlock Grid.Row="0" Grid.Column="0" 
                                                      Text="Name" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      Margin="0,0,0,12"
                                                      VerticalAlignment="Top"/>
                                            <TextBlock Grid.Row="0" Grid.Column="1" 
                                                      Text="{Binding Name}" 
                                                      FontSize="{StaticResource FontSizeM}"
                                                      FontWeight="{StaticResource FontWeightSemiBold}"
                                                      Foreground="{DynamicResource TextPrimaryBrush}"
                                                      TextWrapping="Wrap"
                                                      Margin="0,0,0,12"/>
                                            
                                            <!-- Description Row -->
                                            <TextBlock Grid.Row="1" Grid.Column="0" 
                                                      Text="Description" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      Margin="0,0,0,12"
                                                      VerticalAlignment="Top"/>
                                            <TextBlock Grid.Row="1" Grid.Column="1" 
                                                      Text="{Binding Description}" 
                                                      FontSize="{StaticResource FontSizeM}"
                                                      Foreground="{DynamicResource TextPrimaryBrush}"
                                                      TextWrapping="Wrap"
                                                      Margin="0,0,0,12"/>
                                            
                                            <!-- ID Row -->
                                            <TextBlock Grid.Row="2" Grid.Column="0" 
                                                      Text="ID" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      Margin="0,0,0,12"/>
                                            <TextBlock Grid.Row="2" Grid.Column="1" 
                                                      Text="{Binding Id}" 
                                                      FontSize="{StaticResource FontSizeM}"
                                                      Foreground="{DynamicResource TextPrimaryBrush}"
                                                      Margin="0,0,0,12"/>
                                            
                                            <!-- Version Row -->
                                            <TextBlock Grid.Row="3" Grid.Column="0" 
                                                      Text="Version" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      Margin="0,0,0,12"/>
                                            <TextBlock Grid.Row="3" Grid.Column="1" 
                                                      Text="{Binding Version}" 
                                                      FontSize="{StaticResource FontSizeM}"
                                                      Foreground="{DynamicResource TextPrimaryBrush}"
                                                      Margin="0,0,0,12"/>
                                            
                                            <!-- Category Row -->
                                            <TextBlock Grid.Row="4" Grid.Column="0" 
                                                      Text="Category" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      Margin="0,0,0,12"/>
                                            <TextBlock Grid.Row="4" Grid.Column="1" 
                                                      Text="{Binding Category}" 
                                                      FontSize="{StaticResource FontSizeM}"
                                                      Foreground="{DynamicResource TextPrimaryBrush}"
                                                      Margin="0,0,0,12"/>
                                            
                                            <!-- Privilege Row -->
                                            <TextBlock Grid.Row="5" Grid.Column="0" 
                                                      Text="Privilege" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      Margin="0,0,0,12"/>
                                            <TextBlock Grid.Row="5" Grid.Column="1" 
                                                      Text="{Binding Privilege}" 
                                                      FontSize="{StaticResource FontSizeM}"
                                                      Foreground="{DynamicResource TextPrimaryBrush}"
                                                      Margin="0,0,0,12"/>
                                            
                                            <!-- Timeout Row -->
                                            <TextBlock Grid.Row="6" Grid.Column="0" 
                                                      Text="Timeout" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      Margin="0,0,0,12"/>
                                            <TextBlock Grid.Row="6" Grid.Column="1" 
                                                      Text="{Binding TimeoutSec, StringFormat={}{0}s}" 
                                                      FontSize="{StaticResource FontSizeM}"
                                                      Foreground="{DynamicResource TextPrimaryBrush}"
                                                      Margin="0,0,0,12"/>
                                            
                                            <!-- Tags Row -->
                                            <TextBlock Grid.Row="7" Grid.Column="0" 
                                                      Text="Tags" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      VerticalAlignment="Top"/>
                                            <ItemsControl Grid.Row="7" Grid.Column="1"
                                                         ItemsSource="{Binding Tags}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <WrapPanel Orientation="Horizontal"/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <ui:Badge Content="{Binding}" 
                                                                 Style="{StaticResource TagBadgeStyle}"
                                                                 FontSize="10"
                                                                 Padding="6,2"
                                                                 Margin="0,0,4,4"/>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </Grid>
                                        
                                        <!-- Edit view -->
                                        <StackPanel Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <StackPanel Margin="0,0,0,16">
                                                <TextBlock Text="Name" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                          Margin="0,0,0,6"/>
                                                <ui:TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}"/>
                                            </StackPanel>
                                            <StackPanel Margin="0,0,0,16">
                                                <TextBlock Text="ID" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                          Margin="0,0,0,6"/>
                                                <ui:TextBox Text="{Binding Id, UpdateSourceTrigger=PropertyChanged}"/>
                                            </StackPanel>
                                            <StackPanel Margin="0,0,0,16">
                                                <TextBlock Text="Version" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                          Margin="0,0,0,6"/>
                                                <ui:TextBox Text="{Binding Version, UpdateSourceTrigger=PropertyChanged}"/>
                                            </StackPanel>
                                            <StackPanel Margin="0,0,0,16">
                                                <TextBlock Text="Category" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                          Margin="0,0,0,6"/>
                                                <ui:TextBox Text="{Binding Category, UpdateSourceTrigger=PropertyChanged}"/>
                                            </StackPanel>
                                            <StackPanel Margin="0,0,0,16">
                                                <TextBlock Text="Privilege" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                          Margin="0,0,0,6"/>
                                                <ui:TextBox Text="{Binding Privilege, UpdateSourceTrigger=PropertyChanged}"/>
                                            </StackPanel>
                                            <StackPanel Margin="0,0,0,16">
                                                <TextBlock Text="Timeout (seconds)" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                          Margin="0,0,0,6"/>
                                                <ui:NumberBox Value="{Binding TimeoutSec}" Minimum="0" Maximum="3600"/>
                                            </StackPanel>
                                            <StackPanel>
                                                <TextBlock Text="Description" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                          Margin="0,0,0,6"/>
                                                <ui:TextBox Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </StackPanel>
                                </ui:CardExpander>
                                
                                <ui:CardExpander Header="Parameters" 
                                                IsExpanded="True" 
                                                Visibility="{Binding HasParameters, Converter={StaticResource BoolToVisibilityConverter}}" 
                                                Margin="0,0,0,16">
                                    <StackPanel>
                                        <TextBlock Text="Configure parameter values before running the test case" 
                                                  FontSize="{StaticResource FontSizeS}"
                                                  Foreground="{DynamicResource TextSecondaryBrush}"
                                                  Margin="0,0,0,16"/>
                                        <ItemsControl ItemsSource="{Binding Parameters}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border BorderBrush="{DynamicResource BorderSubtleBrush}" 
                                                           BorderThickness="0,0,0,1" 
                                                           Padding="0,0,0,12" 
                                                           Margin="0,0,0,12">
                                                        <Grid>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                            </Grid.RowDefinitions>
                                                            
                                                            <!-- Parameter name and badges - more compact -->
                                                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,8">
                                                                <TextBlock Text="{Binding Name}" 
                                                                          FontSize="{StaticResource FontSizeM}"
                                                                          FontWeight="{StaticResource FontWeightSemiBold}"
                                                                          Foreground="{DynamicResource TextPrimaryBrush}"
                                                                          VerticalAlignment="Center"
                                                                          Margin="0,0,8,0"/>
                                                                <ui:Badge Content="{Binding Type}" 
                                                                         Appearance="Secondary" 
                                                                         Margin="0,0,4,0"
                                                                         FontSize="10"
                                                                         Padding="6,2"/>
                                                                <ui:Badge Content="required" 
                                                                         Style="{StaticResource RequiredBadgeStyle}"
                                                                         Visibility="{Binding Required, Converter={StaticResource BoolToVisibilityConverter}}"
                                                                         FontSize="10"
                                                                         Padding="6,2"/>
                                                            </StackPanel>
                                                            
                                                            <!-- Help text - tighter spacing -->
                                                            <TextBlock Grid.Row="1" 
                                                                      Text="{Binding Help}" 
                                                                      FontSize="{StaticResource FontSizeS}"
                                                                      Foreground="{DynamicResource TextSecondaryBrush}"
                                                                      TextWrapping="Wrap"
                                                                      LineHeight="18"
                                                                      Margin="0,0,0,8"
                                                                      Visibility="{Binding Help, Converter={StaticResource StringToBoolConverter}}"/>
                                                            
                                                            <!-- Input field -->
                                                            <Grid Grid.Row="2">
                                                                <Grid.RowDefinitions>
                                                                    <RowDefinition Height="Auto"/>
                                                                    <RowDefinition Height="Auto"/>
                                                                </Grid.RowDefinitions>
                                                                
                                                                <ContentPresenter Grid.Row="0"
                                                                                Content="{Binding}"
                                                                                ContentTemplateSelector="{StaticResource ParameterEditorTemplateSelector}"/>
                                                                
                                                                <!-- Error message -->
                                                                <TextBlock Grid.Row="1"
                                                                          Text="{Binding ErrorMessage}"
                                                                          FontSize="{StaticResource FontSizeS}"
                                                                          Foreground="{DynamicResource StatusErrorBrush}"
                                                                          Margin="0,6,0,0"
                                                                          Visibility="{Binding HasError, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                            </Grid>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </ui:CardExpander>
                                </StackPanel>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                    
                </Grid>
            </TabItem>
            
            <!-- Suites Tab -->
            <TabItem Header="Suites" Style="{StaticResource SegmentedControlTabItem}">
                <Grid Margin="0,6,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="380" MinWidth="300"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*" MinWidth="300"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Suites List Card -->
                    <Border Grid.Column="0" 
                            Background="{DynamicResource CardBackgroundBrush}"
                            CornerRadius="{StaticResource RadiusM}"
                            BorderBrush="{DynamicResource CardBorderBrush}"
                            BorderThickness="1">
                        <Border.Effect>
                            <DropShadowEffect Color="{DynamicResource ShadowColor}" BlurRadius="20" ShadowDepth="3" Direction="270" Opacity="0.1"/>
                        </Border.Effect>
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Card Header -->
                            <TextBlock Grid.Row="0" 
                                      Text="Test Suites" 
                                      Style="{StaticResource SectionTitleStyle}"
                                      Margin="20,20,20,0"/>
                            
                            <!-- Action Buttons -->
                            <WrapPanel Grid.Row="1" Margin="20,16,20,0">
                                <ui:Button Content="New" 
                                          Icon="{ui:SymbolIcon Add24}" 
                                          Command="{Binding SuitesTab.CreateCommand}"
                                          Appearance="Primary"
                                          Margin="0,0,8,8"/>
                                <ui:Button Content="Duplicate" 
                                          Icon="{ui:SymbolIcon Copy24}" 
                                          Command="{Binding SuitesTab.DuplicateCommand}" 
                                          Margin="0,0,8,8"/>
                                <ui:Button Content="Delete" 
                                          Icon="{ui:SymbolIcon Delete24}" 
                                          Command="{Binding SuitesTab.DeleteCommand}" 
                                          Margin="0,0,8,8"/>
                                <ui:Button Icon="{ui:SymbolIcon ArrowDownload24}" 
                                          Command="{Binding SuitesTab.ImportCommand}"
                                          ToolTip="Import"
                                          Margin="0,0,8,8"/>
                                <ui:Button Icon="{ui:SymbolIcon ArrowUpload24}" 
                                          Command="{Binding SuitesTab.ExportCommand}"
                                          ToolTip="Export"
                                          Margin="0,0,8,8"/>
                            </WrapPanel>
                            
                            <!-- Search and Filter Row -->
                            <Grid Grid.Row="2" Margin="20,16,20,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="8"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Search Box -->
                                <ui:TextBox Grid.Column="0"
                                           PlaceholderText="Search suites..." 
                                           Text="{Binding SuitesTab.SearchText, UpdateSourceTrigger=PropertyChanged}"
                                           Icon="{ui:SymbolIcon Search24}"/>
                                
                                <!-- Filter Chip (Latest Version) -->
                                <ToggleButton Grid.Column="2"
                                             IsChecked="{Binding SuitesTab.ShowLatestVersionOnly}"
                                             Height="28"
                                             Padding="9,0,10,0"
                                             ToolTip="Show only the latest version of each test suite">
                                    <ToggleButton.Style>
                                        <Style TargetType="ToggleButton">
                                            <Setter Property="Background" Value="Transparent"/>
                                            <Setter Property="BorderBrush" Value="{DynamicResource ControlStrokeColorDefaultBrush}"/>
                                            <Setter Property="BorderThickness" Value="1"/>
                                            <Setter Property="Foreground" Value="{DynamicResource TextFillColorTertiaryBrush}"/>
                                            <Setter Property="FontSize" Value="12"/>
                                            <Setter Property="FontWeight" Value="Normal"/>
                                            <Setter Property="Cursor" Value="Hand"/>
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="ToggleButton">
                                                        <Border x:Name="border"
                                                               Background="{TemplateBinding Background}"
                                                               BorderBrush="{TemplateBinding BorderBrush}"
                                                               BorderThickness="{TemplateBinding BorderThickness}"
                                                               CornerRadius="14"
                                                               Padding="{TemplateBinding Padding}">
                                                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                                                                <TextBlock x:Name="checkmark" 
                                                                          Text="●" 
                                                                          FontSize="8" 
                                                                          Margin="0,0,5,0"
                                                                          Visibility="Collapsed"
                                                                          VerticalAlignment="Center"
                                                                          Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"/>
                                                                <ContentPresenter VerticalAlignment="Center"/>
                                                            </StackPanel>
                                                        </Border>
                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter TargetName="border" Property="Background" Value="{DynamicResource SubtleFillColorSecondaryBrush}"/>
                                                                <Setter TargetName="border" Property="BorderBrush" Value="{DynamicResource ControlStrokeColorSecondaryBrush}"/>
                                                                <Setter Property="Foreground" Value="{DynamicResource TextFillColorSecondaryBrush}"/>
                                                            </Trigger>
                                                            <Trigger Property="IsChecked" Value="True">
                                                                <Setter Property="Background" Value="{DynamicResource ControlFillColorDefaultBrush}"/>
                                                                <Setter Property="BorderBrush" Value="{DynamicResource ControlStrokeColorDefaultBrush}"/>
                                                                <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}"/>
                                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                                                <Setter TargetName="checkmark" Property="Visibility" Value="Visible"/>
                                                            </Trigger>
                                                            <MultiTrigger>
                                                                <MultiTrigger.Conditions>
                                                                    <Condition Property="IsMouseOver" Value="True"/>
                                                                    <Condition Property="IsChecked" Value="True"/>
                                                                </MultiTrigger.Conditions>
                                                                <Setter Property="Background" Value="{DynamicResource ControlFillColorSecondaryBrush}"/>
                                                                <Setter Property="BorderBrush" Value="{DynamicResource ControlStrokeColorSecondaryBrush}"/>
                                                            </MultiTrigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </ToggleButton.Style>
                                    <TextBlock Text="Latest" FontSize="12"/>
                                </ToggleButton>
                            </Grid>
                            
                            <!-- Suites List -->
                            <ListBox x:Name="SuitesListBox"
                                    Grid.Row="3" 
                                    ItemsSource="{Binding SuitesTab.Suites}"
                                    SelectedItem="{Binding SuitesTab.SelectedSuite}"
                                    BorderThickness="0"
                                    Background="Transparent"
                                    VirtualizingPanel.IsVirtualizing="True"
                                    ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                    Padding="8,0,4,0">
                                <ListBox.ItemContainerStyle>
                                    <Style TargetType="ListBoxItem">
                                        <Setter Property="Padding" Value="20,10,16,10"/>
                                        <Setter Property="Margin" Value="2,0,12,2"/>
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Setter Property="BorderThickness" Value="0"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="ListBoxItem">
                                                    <Border Background="{TemplateBinding Background}"
                                                           BorderBrush="{TemplateBinding BorderBrush}"
                                                           BorderThickness="{TemplateBinding BorderThickness}"
                                                           Padding="{TemplateBinding Padding}"
                                                           CornerRadius="6">
                                                        <ContentPresenter/>
                                                    </Border>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="{DynamicResource InteractiveHoverBrush}"/>
                                            </Trigger>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter Property="Background" Value="{DynamicResource InteractiveSelectedBrush}"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </ListBox.ItemContainerStyle>
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <Grid Grid.Column="0">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>
                                                <StackPanel Grid.Row="0" Orientation="Horizontal">
                                                    <TextBlock Text="{Binding Name}" 
                                                              FontWeight="{StaticResource FontWeightSemiBold}"
                                                              FontSize="{StaticResource FontSizeM}"
                                                              Foreground="{DynamicResource TextPrimaryBrush}"
                                                              TextTrimming="CharacterEllipsis"/>
                                                    <ui:SymbolIcon Symbol="Shield24"
                                                                  Foreground="#2F6FED"
                                                                  Filled="True"
                                                                  ToolTip="Administrator required"
                                                                  Margin="6,0,0,0"
                                                                  Visibility="{Binding IsAdminRequired, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                    <ui:SymbolIcon Symbol="Shield24"
                                                                  Foreground="#2F6FED"
                                                                  ToolTip="Administrator recommended"
                                                                  Margin="6,0,0,0"
                                                                  Visibility="{Binding IsAdminPreferred, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                </StackPanel>
                                                <TextBlock Grid.Row="1"
                                                          Text="{Binding Identity}" 
                                                          Foreground="{DynamicResource TextSecondaryBrush}" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Margin="0,2,0,0"
                                                          TextTrimming="CharacterEllipsis"/>
                                                <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,2,0,0">
                                                    <Ellipse Width="4" Height="4" 
                                                            Fill="{DynamicResource TextTertiaryBrush}"
                                                            VerticalAlignment="Center"
                                                            Margin="0,0,6,0"/>
                                                    <TextBlock Foreground="{DynamicResource TextTertiaryBrush}" 
                                                              FontSize="{StaticResource FontSizeXS}">
                                                        <Run Text="{Binding NodeCount}"/>
                                                        <Run Text="nodes"/>
                                                    </TextBlock>
                                                </StackPanel>
                                            </Grid>
                                            <!-- Update indicator -->
                                            <ui:SymbolIcon Grid.Column="1"
                                                          Symbol="ArrowSync20"
                                                          FontSize="14"
                                                          Foreground="#5B8FA3"
                                                          VerticalAlignment="Center"
                                                          Margin="8,0,0,0"
                                                          ToolTip="Updates available"
                                                          Visibility="{Binding HasUpdates, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                        </Grid>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Grid>
                    </Border>
                    
                    <!-- Splitter -->
                    <GridSplitter Grid.Column="1" 
                                 Width="16" 
                                 HorizontalAlignment="Stretch" 
                                 Background="Transparent"
                                 ShowsPreview="False"/>
                    
                    <!-- Suite Editor Card -->
                    <Border Grid.Column="2"
                            Background="{DynamicResource CardBackgroundBrush}"
                            CornerRadius="{StaticResource RadiusM}"
                            BorderBrush="{DynamicResource CardBorderBrush}"
                            BorderThickness="1"
                            Visibility="{Binding SuitesTab.IsEditorVisible, Converter={StaticResource BoolToVisibilityConverter}}">
                        <Border.Effect>
                            <DropShadowEffect Color="{DynamicResource ShadowColor}" BlurRadius="20" ShadowDepth="3" Direction="270" Opacity="0.1"/>
                        </Border.Effect>
                        <Grid DataContext="{Binding SuitesTab.Editor}">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Header -->
                            <Grid Grid.Row="0" Margin="24,24,24,16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Suite Details" 
                                              Style="{StaticResource SectionTitleStyle}"
                                              Margin="0"/>
                                    <ui:Badge Content="Unsaved" 
                                             Appearance="Caution" 
                                             Visibility="{Binding IsDirty, Converter={StaticResource BoolToVisibilityConverter}}"
                                             VerticalAlignment="Center"
                                             Margin="12,0,0,0"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Orientation="Horizontal">
                                    <ui:Button Content="Run" 
                                              Icon="{ui:SymbolIcon Play24}" 
                                              Command="{Binding RunSuiteCommand}" 
                                              Appearance="Primary"
                                              Margin="0,0,8,0"/>
                                    <ui:Button Content="Edit"
                                              Icon="{ui:SymbolIcon Edit24}" 
                                              Command="{Binding EditSuiteCommand}"
                                              Margin="0,0,8,0"/>
                                    <ui:Button Content="Save" 
                                              Icon="{ui:SymbolIcon Save24}" 
                                              Command="{Binding SaveSuiteCommand}" 
                                              Margin="0,0,8,0"/>
                                    <ui:Button Icon="{ui:SymbolIcon CheckmarkCircle24}" 
                                              Command="{Binding ValidateSuiteCommand}"
                                              ToolTip="Validate"
                                              Margin="0,0,8,0"/>
                                    <ui:Button Icon="{ui:SymbolIcon Dismiss24}" 
                                              Command="{Binding DiscardChangesCommand}"
                                              ToolTip="Cancel"/>
                                </StackPanel>
                            </Grid>
                            
                            <!-- Scrollable Content -->
                            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="24,0,24,24">
                                <StackPanel>
                                
                                <!-- Basic Information -->
                                <ui:CardExpander Header="Basic Information" IsExpanded="True" Margin="0,0,0,16">
                                    <StackPanel>
                                        <!-- Read-only view -->
                                        <Grid Visibility="{Binding IsEditing, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="110"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            
                                            <!-- Name Row -->
                                            <TextBlock Grid.Row="0" Grid.Column="0" 
                                                      Text="Name" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      Margin="0,0,0,12"
                                                      VerticalAlignment="Top"/>
                                            <TextBlock Grid.Row="0" Grid.Column="1" 
                                                      Text="{Binding Name}" 
                                                      FontSize="{StaticResource FontSizeM}"
                                                      FontWeight="{StaticResource FontWeightSemiBold}"
                                                      Foreground="{DynamicResource TextPrimaryBrush}"
                                                      TextWrapping="Wrap"
                                                      Margin="0,0,0,12"/>
                                            
                                            <!-- Description Row -->
                                            <TextBlock Grid.Row="1" Grid.Column="0" 
                                                      Text="Description" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      Margin="0,0,0,12"
                                                      VerticalAlignment="Top"/>
                                            <TextBlock Grid.Row="1" Grid.Column="1" 
                                                      Text="{Binding Description}" 
                                                      FontSize="{StaticResource FontSizeM}"
                                                      Foreground="{DynamicResource TextPrimaryBrush}"
                                                      TextWrapping="Wrap"
                                                      Margin="0,0,0,12"/>
                                            
                                            <!-- ID Row -->
                                            <TextBlock Grid.Row="2" Grid.Column="0" 
                                                      Text="ID" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      Margin="0,0,0,12"/>
                                            <TextBlock Grid.Row="2" Grid.Column="1" 
                                                      Text="{Binding Id}" 
                                                      FontSize="{StaticResource FontSizeM}"
                                                      Foreground="{DynamicResource TextPrimaryBrush}"
                                                      Margin="0,0,0,12"/>
                                            
                                            <!-- Version Row -->
                                            <TextBlock Grid.Row="3" Grid.Column="0" 
                                                      Text="Version" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      Margin="0,0,0,12"/>
                                            <TextBlock Grid.Row="3" Grid.Column="1" 
                                                      Text="{Binding Version}" 
                                                      FontSize="{StaticResource FontSizeM}"
                                                      Foreground="{DynamicResource TextPrimaryBrush}"
                                                      Margin="0,0,0,12"/>
                                            
                                            <!-- Tags Row -->
                                            <TextBlock Grid.Row="4" Grid.Column="0" 
                                                      Text="Tags" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      VerticalAlignment="Top"/>
                                            <ItemsControl Grid.Row="4" Grid.Column="1"
                                                         ItemsSource="{Binding Tags}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <WrapPanel Orientation="Horizontal"/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <ui:Badge Content="{Binding}" 
                                                                 Style="{StaticResource TagBadgeStyle}"
                                                                 FontSize="10"
                                                                 Padding="6,2"
                                                                 Margin="0,0,4,4"/>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </Grid>
                                        
                                        <!-- Edit view -->
                                        <StackPanel Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <StackPanel Margin="0,0,0,16">
                                                <TextBlock Text="Name" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                          Margin="0,0,0,6"/>
                                                <ui:TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}"/>
                                            </StackPanel>
                                            <StackPanel Margin="0,0,0,16">
                                                <TextBlock Text="Description" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                          Margin="0,0,0,6"/>
                                                <ui:TextBox Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}"/>
                                            </StackPanel>
                                            <StackPanel Margin="0,0,0,16">
                                                <TextBlock Text="ID" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                          Margin="0,0,0,6"/>
                                                <ui:TextBox Text="{Binding Id, UpdateSourceTrigger=PropertyChanged}"/>
                                                <TextBlock Text="Must be globally unique. Examples: suite.sw.os.ver_check; suite.hw.camera_check" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Foreground="{DynamicResource TextSecondaryBrush}"
                                                          TextWrapping="Wrap"
                                                          Margin="0,6,0,0"/>
                                            </StackPanel>
                                            <StackPanel Margin="0,0,0,16">
                                                <TextBlock Text="Version" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                          Margin="0,0,0,6"/>
                                                <ui:TextBox Text="{Binding Version, UpdateSourceTrigger=PropertyChanged}"/>
                                            </StackPanel>
                                            <StackPanel>
                                                <TextBlock Text="Tags (comma-separated)" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                          Margin="0,0,0,6"/>
                                                <ui:TextBox Text="{Binding TagsText, UpdateSourceTrigger=PropertyChanged}"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </StackPanel>
                                </ui:CardExpander>
                                
                                <!-- Test Flow -->
                                <ui:CardExpander IsExpanded="True" Margin="0,0,0,16">
                                    <ui:CardExpander.Header>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                                <TextBlock Text="Test Flow" VerticalAlignment="Center"/>
                                                <!-- Update Available Indicator -->
                                                <Border Background="Transparent" 
                                                       BorderBrush="Transparent"
                                                       BorderThickness="0"
                                                       Padding="7,3"
                                                       Margin="10,0,0,0"
                                                       Visibility="{Binding HasUpdatableNodes, Converter={StaticResource BoolToVisibilityConverter}}">
                                                    <StackPanel Orientation="Horizontal">
                                                        <ui:SymbolIcon Symbol="ArrowSync24"
                                                                      FontSize="11"
                                                                      Foreground="#6B9080"
                                                                      Margin="0,0,5,0"/>
                                                        <TextBlock FontSize="11" 
                                                                  FontWeight="Normal"
                                                                  Foreground="{DynamicResource TextSecondaryBrush}">
                                                            <Run Text="{Binding UpdatableNodesCount, Mode=OneWay}"/>
                                                            <Run Text="update(s) available"/>
                                                        </TextBlock>
                                                    </StackPanel>
                                                </Border>
                                            </StackPanel>
                                            <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="16,0,32,0">
                                                <!-- Update All Button -->
                                                <ui:Button Content="Update All" 
                                                          Icon="{ui:SymbolIcon ArrowSync24}" 
                                                          Command="{Binding UpdateAllNodesCommand}"
                                                          Visibility="{Binding HasUpdatableNodes, Converter={StaticResource BoolToVisibilityConverter}}"
                                                          Appearance="Primary"
                                                          ToolTip="Update all test cases to latest versions"
                                                          Margin="0,0,16,0"/>
                                                <Separator Width="1" 
                                                          Background="{DynamicResource BorderSubtleBrush}"
                                                          Margin="0,4"
                                                          Visibility="{Binding HasUpdatableNodes, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                <ui:Button Icon="{ui:SymbolIcon ArrowUp24}" 
                                                          Command="{Binding MoveNodeUpCommand}"
                                                          ToolTip="Move Up"
                                                          IsEnabled="{Binding IsEditing}"
                                                          Margin="16,0,8,0"/>
                                                <ui:Button Icon="{ui:SymbolIcon ArrowDown24}" 
                                                          Command="{Binding MoveNodeDownCommand}"
                                                          ToolTip="Move Down"
                                                          IsEnabled="{Binding IsEditing}"
                                                          Margin="0,0,8,0"/>
                                                <ui:Button Content="Remove" 
                                                          Icon="{ui:SymbolIcon Delete24}" 
                                                          Command="{Binding RemoveNodeCommand}"
                                                          IsEnabled="{Binding IsEditing}"
                                                          Margin="0,0,8,0"/>
                                                <ui:Button Content="Add Case" 
                                                          Icon="{ui:SymbolIcon Add24}" 
                                                          Command="{Binding AddNodeCommand}"
                                                          IsEnabled="{Binding IsEditing}"
                                                          Appearance="Primary"/>
                                            </StackPanel>
                                        </Grid>
                                    </ui:CardExpander.Header>
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="240"/>
                                            <RowDefinition Height="16"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        
                                        <!-- Nodes List -->
                                        <Border Grid.Row="0"
                                               Background="{DynamicResource ControlBackgroundSecondaryBrush}"
                                               BorderBrush="{DynamicResource BorderSubtleBrush}"
                                               BorderThickness="1"
                                               CornerRadius="8">
                                            <ListBox ItemsSource="{Binding Nodes}"
                                                    SelectedItem="{Binding SelectedNode}"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Padding="4">
                                                <ListBox.ItemContainerStyle>
                                                    <Style TargetType="ListBoxItem">
                                                        <Setter Property="Padding" Value="12,8"/>
                                                        <Setter Property="Margin" Value="0,0,0,2"/>
                                                        <Setter Property="Background" Value="Transparent"/>
                                                        <Setter Property="BorderThickness" Value="0"/>
                                                        <Setter Property="Template">
                                                            <Setter.Value>
                                                                <ControlTemplate TargetType="ListBoxItem">
                                                                    <Border Background="{TemplateBinding Background}"
                                                                           BorderBrush="{TemplateBinding BorderBrush}"
                                                                           BorderThickness="{TemplateBinding BorderThickness}"
                                                                           Padding="{TemplateBinding Padding}"
                                                                           CornerRadius="6">
                                                                        <ContentPresenter/>
                                                                    </Border>
                                                                </ControlTemplate>
                                                            </Setter.Value>
                                                        </Setter>
                                                        <Style.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Background" Value="{DynamicResource InteractiveHoverBrush}"/>
                                                            </Trigger>
                                                            <Trigger Property="IsSelected" Value="True">
                                                                <Setter Property="Background" Value="{DynamicResource InteractiveSelectedBrush}"/>
                                                            </Trigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ListBox.ItemContainerStyle>
                                                <ListBox.ItemTemplate>
                                                    <DataTemplate>
                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="Auto"/>
                                                                <ColumnDefinition Width="*"/>
                                                                <ColumnDefinition Width="Auto"/>
                                                            </Grid.ColumnDefinitions>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                            </Grid.RowDefinitions>
                                                            
                                                            <Ellipse Grid.Row="0" Grid.Column="0"
                                                                    Width="6" Height="6"
                                                                    Fill="{StaticResource BrandPrimaryBrush}"
                                                                    VerticalAlignment="Center"
                                                                    Margin="0,0,10,0"/>
                                                            
                                                            <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                                                                <TextBlock Text="{Binding Ref}" 
                                                                          FontWeight="{StaticResource FontWeightSemiBold}"
                                                                          FontSize="{StaticResource FontSizeM}"
                                                                          Foreground="{DynamicResource TextPrimaryBrush}"
                                                                          VerticalAlignment="Center"/>
                                                                <ui:SymbolIcon Symbol="Shield24"
                                                                              Foreground="#2F6FED"
                                                                              Filled="True"
                                                                              ToolTip="Administrator required"
                                                                              Margin="6,0,0,0"
                                                                              VerticalAlignment="Center"
                                                                              Visibility="{Binding IsAdminRequired, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                                <ui:SymbolIcon Symbol="Shield24"
                                                                              Foreground="#2F6FED"
                                                                              ToolTip="Administrator recommended"
                                                                              Margin="6,0,0,0"
                                                                              VerticalAlignment="Center"
                                                                              Visibility="{Binding IsAdminPreferred, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                                <!-- Update Available Chip -->
                                                                <Border Background="Transparent" 
                                                                       BorderBrush="Transparent"
                                                                       BorderThickness="0"
                                                                       Padding="0"
                                                                       Margin="8,0,0,0"
                                                                       VerticalAlignment="Center"
                                                                       Visibility="{Binding HasUpdate, Converter={StaticResource BoolToVisibilityConverter}}">
                                                                    <StackPanel Orientation="Horizontal">
                                                                        <ui:SymbolIcon Symbol="ArrowCircleUp20"
                                                                                      FontSize="12"
                                                                                      Foreground="#5B8FA3"
                                                                                      Margin="0,0,4,0"
                                                                                      VerticalAlignment="Center"/>
                                                                        <TextBlock FontSize="10.5" 
                                                                                  FontWeight="Normal"
                                                                                  Foreground="{DynamicResource TextSecondaryBrush}"
                                                                                  VerticalAlignment="Center"
                                                                                  Text="{Binding LatestVersion, StringFormat='v{0} available'}"/>
                                                                    </StackPanel>
                                                                </Border>
                                                            </StackPanel>
                                                            
                                                            <!-- Update Button (appears on hover/selection) -->
                                                            <ui:Button Grid.Row="0" Grid.Column="2"
                                                                      Content="Update"
                                                                      Icon="{ui:SymbolIcon ArrowSync20}"
                                                                      FontSize="11"
                                                                      Padding="8,2"
                                                                      Margin="8,0,0,0"
                                                                      Command="{Binding DataContext.UpdateNodeCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                                                      CommandParameter="{Binding}"
                                                                      Visibility="{Binding HasUpdate, Converter={StaticResource BoolToVisibilityConverter}}"
                                                                      ToolTip="Update to latest version"/>
                                                            
                                                            <TextBlock Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2"
                                                                      Text="{Binding NodeId}" 
                                                                      Foreground="{DynamicResource TextSecondaryBrush}"
                                                                      FontSize="{StaticResource FontSizeXS}"
                                                                      Margin="0,2,0,0"/>
                                                        </Grid>
                                                    </DataTemplate>
                                                </ListBox.ItemTemplate>
                                            </ListBox>
                                        </Border>
                                        
                                        <!-- Node Editor -->
                                        <Border Grid.Row="3" 
                                               Padding="16" 
                                               Background="{DynamicResource ControlBackgroundSecondaryBrush}"
                                               BorderBrush="{DynamicResource BorderSubtleBrush}"
                                               BorderThickness="1"
                                               CornerRadius="8"
                                               DataContext="{Binding SelectedNode}"
                                               Visibility="{Binding DataContext.SelectedNode, RelativeSource={RelativeSource AncestorType=StackPanel}, Converter={StaticResource NullToVisibilityConverter}}"
                                               IsEnabled="{Binding DataContext.IsEditing, RelativeSource={RelativeSource AncestorType=StackPanel}}">
                                            <StackPanel>
                                                <TextBlock Text="Node Configuration"
                                                          FontSize="{StaticResource FontSizeL}"
                                                          FontWeight="{StaticResource FontWeightSemiBold}"
                                                          Foreground="{DynamicResource TextPrimaryBrush}"
                                                          Margin="0,0,0,16"/>
                                                
                                                <StackPanel Margin="0,0,0,16">
                                                    <TextBlock Text="Node ID" 
                                                              FontSize="{StaticResource FontSizeXS}"
                                                              Foreground="{DynamicResource TextTertiaryBrush}"
                                                              Margin="0,0,0,6"/>
                                                    <ui:TextBox Text="{Binding NodeId, UpdateSourceTrigger=PropertyChanged}" IsReadOnly="True"/>
                                                </StackPanel>
                                                
                                                <StackPanel Margin="0,0,0,16">
                                                    <TextBlock Text="Test Case Reference" 
                                                              FontSize="{StaticResource FontSizeXS}"
                                                              Foreground="{DynamicResource TextTertiaryBrush}"
                                                              Margin="0,0,0,6"/>
                                                    <ui:TextBox Text="{Binding Ref, UpdateSourceTrigger=PropertyChanged}"/>
                                                </StackPanel>
                                                
                                                <!-- Parameters Section -->
                                                <StackPanel Margin="0,0,0,16"
                                                           Visibility="{Binding HasParameters, Converter={StaticResource BoolToVisibilityConverter}}">
                                                    <TextBlock Text="Parameters" 
                                                              FontSize="{StaticResource FontSizeXS}"
                                                              Foreground="{DynamicResource TextTertiaryBrush}"
                                                              Margin="0,0,0,12"/>
                                                    <ItemsControl ItemsSource="{Binding Parameters}">
                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate>
                                                                <Border BorderBrush="{DynamicResource BorderSubtleBrush}" 
                                                                       BorderThickness="0,0,0,1" 
                                                                       Padding="0,0,0,12" 
                                                                       Margin="0,0,0,12">
                                                                    <Grid>
                                                                        <Grid.RowDefinitions>
                                                                            <RowDefinition Height="Auto"/>
                                                                            <RowDefinition Height="Auto"/>
                                                                            <RowDefinition Height="Auto"/>
                                                                        </Grid.RowDefinitions>
                                                                        
                                                                        <!-- Parameter name and badges - more compact -->
                                                                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,8">
                                                                            <TextBlock Text="{Binding Name}" 
                                                                                      FontSize="{StaticResource FontSizeM}"
                                                                                      FontWeight="{StaticResource FontWeightSemiBold}"
                                                                                      Foreground="{DynamicResource TextPrimaryBrush}"
                                                                                      VerticalAlignment="Center"
                                                                                      Margin="0,0,8,0"/>
                                                                            <ui:Badge Content="{Binding Type}" 
                                                                                     Appearance="Secondary" 
                                                                                     Margin="0,0,4,0"
                                                                                     FontSize="10"
                                                                                     Padding="6,2"/>
                                                                            <ui:Badge Content="required" 
                                                                                     Style="{StaticResource RequiredBadgeStyle}"
                                                                                     Visibility="{Binding Required, Converter={StaticResource BoolToVisibilityConverter}}"
                                                                                     FontSize="10"
                                                                                     Padding="6,2"/>
                                                                        </StackPanel>
                                                                        
                                                                        <!-- Help text - tighter spacing -->
                                                                        <TextBlock Grid.Row="1" 
                                                                                  Text="{Binding Help}" 
                                                                                  FontSize="{StaticResource FontSizeS}"
                                                                                  Foreground="{DynamicResource TextSecondaryBrush}"
                                                                                  TextWrapping="Wrap"
                                                                                  LineHeight="18"
                                                                                  Margin="0,0,0,8"
                                                                                  Visibility="{Binding Help, Converter={StaticResource StringToBoolConverter}}"/>
                                                                        
                                                                        <!-- Input field -->
                                                                        <Grid Grid.Row="2">
                                                                            <Grid.RowDefinitions>
                                                                                <RowDefinition Height="Auto"/>
                                                                                <RowDefinition Height="Auto"/>
                                                                            </Grid.RowDefinitions>
                                                                            
                                                                            <ContentPresenter Grid.Row="0"
                                                                                            Content="{Binding}"
                                                                                            ContentTemplateSelector="{StaticResource ParameterEditorTemplateSelector}"/>
                                                                            
                                                                            <!-- Error message -->
                                                                            <TextBlock Grid.Row="1"
                                                                                      Text="{Binding ErrorMessage}"
                                                                                      FontSize="{StaticResource FontSizeS}"
                                                                                      Foreground="{DynamicResource StatusErrorBrush}"
                                                                                      Margin="0,6,0,0"
                                                                                      Visibility="{Binding HasError, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                                        </Grid>
                                                                    </Grid>
                                                                </Border>
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                    </ItemsControl>
                                                </StackPanel>
                                                
                                                <!-- JSON Fallback -->
                                                <StackPanel Visibility="{Binding HasParameters, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                                    <TextBlock Text="Inputs (JSON)" 
                                                              FontSize="{StaticResource FontSizeXS}"
                                                              Foreground="{DynamicResource TextTertiaryBrush}"
                                                              Margin="0,0,0,6"/>
                                                    <TextBox Text="{Binding InputsJson, UpdateSourceTrigger=PropertyChanged}" 
                                                            AcceptsReturn="True" 
                                                            Height="100" 
                                                            FontFamily="Consolas"
                                                            FontSize="11"
                                                            VerticalScrollBarVisibility="Auto"
                                                            Background="{DynamicResource CardBackgroundBrush}"/>
                                                </StackPanel>
                                            </StackPanel>
                                        </Border>
                                    </Grid>
                                </ui:CardExpander>
                                
                                <!-- Environment -->
                                <ui:CardExpander IsExpanded="False" Margin="0,0,0,16">
                                    <ui:CardExpander.Header>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="Environment Variables" VerticalAlignment="Center"/>
                                            <ui:Button Grid.Column="1" 
                                                      Content="Add"
                                                      Icon="{ui:SymbolIcon Add24}"
                                                      Command="{Binding EnvironmentEditor.AddRowCommand}"
                                                      IsEnabled="{Binding IsEditing}"
                                                      Appearance="Primary"
                                                      Margin="16,0,32,0"/>
                                        </Grid>
                                    </ui:CardExpander.Header>
                                    <Grid IsEnabled="{Binding IsEditing}">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="280"/>
                                        </Grid.RowDefinitions>

                                        <!-- Environment Editor Control -->
                                        <ContentControl Grid.Row="0"
                                                       Content="{Binding EnvironmentEditor}"
                                                       HorizontalAlignment="Stretch"
                                                       VerticalAlignment="Stretch">
                                            <ContentControl.ContentTemplate>
                                                <DataTemplate>
                                                    <local:EnvVarEditor/>
                                                </DataTemplate>
                                            </ContentControl.ContentTemplate>
                                        </ContentControl>
                                    </Grid>
                                </ui:CardExpander>
                                
                                <!-- Controls -->
                                <ui:CardExpander Header="Execution Controls" IsExpanded="False" Margin="0,0,0,16">
                                    <Grid IsEnabled="{Binding IsEditing}">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="8"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="8"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <!-- Repeat Count -->
                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="Repeat Count" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      Margin="0,0,0,4"/>
                                            <ui:NumberBox Value="{Binding Repeat, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                         Minimum="1" 
                                                         Maximum="100"
                                                         SpinButtonPlacementMode="Compact"/>
                                        </StackPanel>
                                        
                                        <!-- Retry on Error -->
                                        <StackPanel Grid.Column="2">
                                            <TextBlock Text="Retry on Error" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      Margin="0,0,0,4"/>
                                            <ui:NumberBox Value="{Binding RetryOnError, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                         Minimum="0" 
                                                         Maximum="10"
                                                         SpinButtonPlacementMode="Compact"/>
                                        </StackPanel>
                                        
                                        <!-- Continue on Failure -->
                                        <StackPanel Grid.Column="4">
                                            <TextBlock Text="Continue on Failure" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      Margin="0,0,0,4"/>
                                            <ui:ToggleSwitch IsChecked="{Binding ContinueOnFailure, Mode=TwoWay}"
                                                            OnContent="Yes"
                                                            OffContent="No"/>
                                        </StackPanel>
                                    </Grid>
                                </ui:CardExpander>
                                </StackPanel>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </Grid>
            </TabItem>
            
            <!-- Plans Tab -->
            <TabItem Header="Plans" Style="{StaticResource SegmentedControlTabItem}">
                <Grid Margin="0,6,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="380" MinWidth="300"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*" MinWidth="300"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Plans List Card -->
                    <Border Grid.Column="0" 
                            Background="{DynamicResource CardBackgroundBrush}"
                            CornerRadius="{StaticResource RadiusM}"
                            BorderBrush="{DynamicResource CardBorderBrush}"
                            BorderThickness="1">
                        <Border.Effect>
                            <DropShadowEffect Color="{DynamicResource ShadowColor}" BlurRadius="20" ShadowDepth="3" Direction="270" Opacity="0.1"/>
                        </Border.Effect>
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Card Header -->
                            <TextBlock Grid.Row="0" 
                                      Text="Test Plans" 
                                      Style="{StaticResource SectionTitleStyle}"
                                      Margin="20,20,20,0"/>
                            
                            <!-- Action Buttons -->
                            <WrapPanel Grid.Row="1" Margin="20,16,20,0">
                                <ui:Button Content="New" 
                                          Icon="{ui:SymbolIcon Add24}" 
                                          Command="{Binding PlansTab.CreateCommand}"
                                          Appearance="Primary"
                                          Margin="0,0,8,8"/>
                                <ui:Button Content="Duplicate" 
                                          Icon="{ui:SymbolIcon Copy24}" 
                                          Command="{Binding PlansTab.DuplicateCommand}" 
                                          Margin="0,0,8,8"/>
                                <ui:Button Content="Delete" 
                                          Icon="{ui:SymbolIcon Delete24}" 
                                          Command="{Binding PlansTab.DeleteCommand}" 
                                          Margin="0,0,8,8"/>
                                <ui:Button Icon="{ui:SymbolIcon ArrowDownload24}" 
                                          Command="{Binding PlansTab.ImportCommand}"
                                          ToolTip="Import"
                                          Margin="0,0,8,8"/>
                                <ui:Button Icon="{ui:SymbolIcon ArrowUpload24}" 
                                          Command="{Binding PlansTab.ExportCommand}"
                                          ToolTip="Export"
                                          Margin="0,0,8,8"/>
                            </WrapPanel>
                            
                            <!-- Search and Filter Row -->
                            <Grid Grid.Row="2" Margin="20,16,20,12">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="8"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Search Box -->
                                <ui:TextBox Grid.Column="0"
                                           PlaceholderText="Search plans..." 
                                           Text="{Binding PlansTab.SearchText, UpdateSourceTrigger=PropertyChanged}"
                                           Icon="{ui:SymbolIcon Search24}"/>
                                
                                <!-- Filter Chip (Latest Version) -->
                                <ToggleButton Grid.Column="2"
                                             IsChecked="{Binding PlansTab.ShowLatestVersionOnly}"
                                             Height="28"
                                             Padding="9,0,10,0"
                                             ToolTip="Show only the latest version of each test plan">
                                    <ToggleButton.Style>
                                        <Style TargetType="ToggleButton">
                                            <Setter Property="Background" Value="Transparent"/>
                                            <Setter Property="BorderBrush" Value="{DynamicResource ControlStrokeColorDefaultBrush}"/>
                                            <Setter Property="BorderThickness" Value="1"/>
                                            <Setter Property="Foreground" Value="{DynamicResource TextFillColorTertiaryBrush}"/>
                                            <Setter Property="FontSize" Value="12"/>
                                            <Setter Property="FontWeight" Value="Normal"/>
                                            <Setter Property="Cursor" Value="Hand"/>
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="ToggleButton">
                                                        <Border x:Name="border"
                                                               Background="{TemplateBinding Background}"
                                                               BorderBrush="{TemplateBinding BorderBrush}"
                                                               BorderThickness="{TemplateBinding BorderThickness}"
                                                               CornerRadius="14"
                                                               Padding="{TemplateBinding Padding}">
                                                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                                                                <TextBlock x:Name="checkmark" 
                                                                          Text="●" 
                                                                          FontSize="8" 
                                                                          Margin="0,0,5,0"
                                                                          Visibility="Collapsed"
                                                                          VerticalAlignment="Center"
                                                                          Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"/>
                                                                <ContentPresenter VerticalAlignment="Center"/>
                                                            </StackPanel>
                                                        </Border>
                                                        <ControlTemplate.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter TargetName="border" Property="Background" Value="{DynamicResource SubtleFillColorSecondaryBrush}"/>
                                                                <Setter TargetName="border" Property="BorderBrush" Value="{DynamicResource ControlStrokeColorSecondaryBrush}"/>
                                                                <Setter Property="Foreground" Value="{DynamicResource TextFillColorSecondaryBrush}"/>
                                                            </Trigger>
                                                            <Trigger Property="IsChecked" Value="True">
                                                                <Setter Property="Background" Value="{DynamicResource ControlFillColorDefaultBrush}"/>
                                                                <Setter Property="BorderBrush" Value="{DynamicResource ControlStrokeColorDefaultBrush}"/>
                                                                <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}"/>
                                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                                                <Setter TargetName="checkmark" Property="Visibility" Value="Visible"/>
                                                            </Trigger>
                                                            <MultiTrigger>
                                                                <MultiTrigger.Conditions>
                                                                    <Condition Property="IsMouseOver" Value="True"/>
                                                                    <Condition Property="IsChecked" Value="True"/>
                                                                </MultiTrigger.Conditions>
                                                                <Setter Property="Background" Value="{DynamicResource ControlFillColorSecondaryBrush}"/>
                                                                <Setter Property="BorderBrush" Value="{DynamicResource ControlStrokeColorSecondaryBrush}"/>
                                                            </MultiTrigger>
                                                        </ControlTemplate.Triggers>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </ToggleButton.Style>
                                    <TextBlock Text="Latest" FontSize="12"/>
                                </ToggleButton>
                            </Grid>
                            
                            <!-- Plans List -->
                            <ListBox x:Name="PlansListBox"
                                    Grid.Row="3" 
                                    ItemsSource="{Binding PlansTab.Plans}"
                                    SelectedItem="{Binding PlansTab.SelectedPlan}"
                                    BorderThickness="0"
                                    Background="Transparent"
                                    VirtualizingPanel.IsVirtualizing="True"
                                    ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                    Padding="8,0,4,0">
                                <ListBox.ItemContainerStyle>
                                    <Style TargetType="ListBoxItem">
                                        <Setter Property="Padding" Value="20,10,16,10"/>
                                        <Setter Property="Margin" Value="2,0,12,2"/>
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Setter Property="BorderThickness" Value="0"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="ListBoxItem">
                                                    <Border Background="{TemplateBinding Background}"
                                                           BorderBrush="{TemplateBinding BorderBrush}"
                                                           BorderThickness="{TemplateBinding BorderThickness}"
                                                           Padding="{TemplateBinding Padding}"
                                                           CornerRadius="6">
                                                        <ContentPresenter/>
                                                    </Border>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                        <Style.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="{DynamicResource InteractiveHoverBrush}"/>
                                            </Trigger>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter Property="Background" Value="{DynamicResource InteractiveSelectedBrush}"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </ListBox.ItemContainerStyle>
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <Grid Grid.Column="0">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>
                                                <StackPanel Grid.Row="0" Orientation="Horizontal">
                                                    <TextBlock Text="{Binding Name}" 
                                                              FontWeight="{StaticResource FontWeightSemiBold}"
                                                              FontSize="{StaticResource FontSizeM}"
                                                              Foreground="{DynamicResource TextPrimaryBrush}"
                                                              TextTrimming="CharacterEllipsis"/>
                                                    <ui:SymbolIcon Symbol="Shield24"
                                                                  Foreground="#2F6FED"
                                                                  Filled="True"
                                                                  ToolTip="Administrator required"
                                                                  Margin="6,0,0,0"
                                                                  Visibility="{Binding IsAdminRequired, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                    <ui:SymbolIcon Symbol="Shield24"
                                                                  Foreground="#2F6FED"
                                                                  ToolTip="Administrator recommended"
                                                                  Margin="6,0,0,0"
                                                                  Visibility="{Binding IsAdminPreferred, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                </StackPanel>
                                                <TextBlock Grid.Row="1"
                                                          Text="{Binding Identity}" 
                                                          Foreground="{DynamicResource TextSecondaryBrush}" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Margin="0,2,0,0"
                                                          TextTrimming="CharacterEllipsis"/>
                                                <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,2,0,0">
                                                    <Ellipse Width="4" Height="4" 
                                                            Fill="{DynamicResource TextTertiaryBrush}"
                                                            VerticalAlignment="Center"
                                                            Margin="0,0,6,0"/>
                                                    <TextBlock Foreground="{DynamicResource TextTertiaryBrush}" 
                                                              FontSize="{StaticResource FontSizeXS}">
                                                        <Run Text="{Binding SuiteCount}"/>
                                                        <Run Text="suites"/>
                                                    </TextBlock>
                                                </StackPanel>
                                            </Grid>
                                            <!-- Update indicator -->
                                            <ui:SymbolIcon Grid.Column="1"
                                                          Symbol="ArrowSync20"
                                                          FontSize="14"
                                                          Foreground="#5B8FA3"
                                                          VerticalAlignment="Center"
                                                          Margin="8,0,0,0"
                                                          ToolTip="Updates available"
                                                          Visibility="{Binding HasUpdates, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                        </Grid>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Grid>
                    </Border>
                    
                    <!-- Splitter -->
                    <GridSplitter Grid.Column="1" 
                                 Width="16" 
                                 HorizontalAlignment="Stretch" 
                                 Background="Transparent"
                                 ShowsPreview="False"/>
                    
                    <!-- Plan Editor Card -->
                    <Border Grid.Column="2"
                            Background="{DynamicResource CardBackgroundBrush}"
                            CornerRadius="{StaticResource RadiusM}"
                            BorderBrush="{DynamicResource CardBorderBrush}"
                            BorderThickness="1"
                            Visibility="{Binding PlansTab.IsEditorVisible, Converter={StaticResource BoolToVisibilityConverter}}">
                        <Border.Effect>
                            <DropShadowEffect Color="{DynamicResource ShadowColor}" BlurRadius="20" ShadowDepth="3" Direction="270" Opacity="0.1"/>
                        </Border.Effect>
                        <Grid DataContext="{Binding PlansTab.Editor}">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Header -->
                            <Grid Grid.Row="0" Margin="24,24,24,16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Plan Details" 
                                              Style="{StaticResource SectionTitleStyle}"
                                              Margin="0"/>
                                    <ui:Badge Content="Unsaved" 
                                             Appearance="Caution" 
                                             Visibility="{Binding IsDirty, Converter={StaticResource BoolToVisibilityConverter}}"
                                             VerticalAlignment="Center"
                                             Margin="12,0,0,0"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Orientation="Horizontal">
                                    <ui:Button Content="Run" 
                                              Icon="{ui:SymbolIcon Play24}" 
                                              Command="{Binding RunPlanCommand}" 
                                              Appearance="Primary"
                                              Margin="0,0,8,0"/>
                                    <ui:Button Content="Edit"
                                              Icon="{ui:SymbolIcon Edit24}" 
                                              Command="{Binding EditPlanCommand}"
                                              Margin="0,0,8,0"/>
                                    <ui:Button Content="Save" 
                                              Icon="{ui:SymbolIcon Save24}" 
                                              Command="{Binding SavePlanCommand}" 
                                              Margin="0,0,8,0"/>
                                    <ui:Button Icon="{ui:SymbolIcon CheckmarkCircle24}" 
                                              Command="{Binding ValidatePlanCommand}"
                                              ToolTip="Validate"
                                              Margin="0,0,8,0"/>
                                    <ui:Button Icon="{ui:SymbolIcon Dismiss24}" 
                                              Command="{Binding DiscardChangesCommand}"
                                              ToolTip="Cancel"/>
                                </StackPanel>
                            </Grid>
                            
                            <!-- Scrollable Content -->
                            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="24,0,24,24">
                                <StackPanel>
                                
                                <!-- Basic Information -->
                                <ui:CardExpander Header="Basic Information" IsExpanded="True" Margin="0,0,0,16">
                                    <StackPanel>
                                        <!-- Read-only view -->
                                        <Grid Visibility="{Binding IsEditing, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="110"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            
                                            <!-- Name Row -->
                                            <TextBlock Grid.Row="0" Grid.Column="0" 
                                                      Text="Name" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      Margin="0,0,0,12"
                                                      VerticalAlignment="Top"/>
                                            <TextBlock Grid.Row="0" Grid.Column="1" 
                                                      Text="{Binding Name}" 
                                                      FontSize="{StaticResource FontSizeM}"
                                                      FontWeight="{StaticResource FontWeightSemiBold}"
                                                      Foreground="{DynamicResource TextPrimaryBrush}"
                                                      TextWrapping="Wrap"
                                                      Margin="0,0,0,12"/>
                                            
                                            <!-- Description Row -->
                                            <TextBlock Grid.Row="1" Grid.Column="0" 
                                                      Text="Description" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      Margin="0,0,0,12"
                                                      VerticalAlignment="Top"/>
                                            <TextBlock Grid.Row="1" Grid.Column="1" 
                                                      Text="{Binding Description}" 
                                                      FontSize="{StaticResource FontSizeM}"
                                                      Foreground="{DynamicResource TextPrimaryBrush}"
                                                      TextWrapping="Wrap"
                                                      Margin="0,0,0,12"/>
                                            
                                            <!-- ID Row -->
                                            <TextBlock Grid.Row="2" Grid.Column="0" 
                                                      Text="ID" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      Margin="0,0,0,12"/>
                                            <TextBlock Grid.Row="2" Grid.Column="1" 
                                                      Text="{Binding Id}" 
                                                      FontSize="{StaticResource FontSizeM}"
                                                      Foreground="{DynamicResource TextPrimaryBrush}"
                                                      Margin="0,0,0,12"/>
                                            
                                            <!-- Version Row -->
                                            <TextBlock Grid.Row="3" Grid.Column="0" 
                                                      Text="Version" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      Margin="0,0,0,12"/>
                                            <TextBlock Grid.Row="3" Grid.Column="1" 
                                                      Text="{Binding Version}" 
                                                      FontSize="{StaticResource FontSizeM}"
                                                      Foreground="{DynamicResource TextPrimaryBrush}"
                                                      Margin="0,0,0,12"/>
                                            
                                            <!-- Tags Row -->
                                            <TextBlock Grid.Row="4" Grid.Column="0" 
                                                      Text="Tags" 
                                                      FontSize="{StaticResource FontSizeXS}"
                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                      VerticalAlignment="Top"/>
                                            <ItemsControl Grid.Row="4" Grid.Column="1"
                                                         ItemsSource="{Binding Tags}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <WrapPanel Orientation="Horizontal"/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <ui:Badge Content="{Binding}" 
                                                                 Style="{StaticResource TagBadgeStyle}"
                                                                 FontSize="10"
                                                                 Padding="6,2"
                                                                 Margin="0,0,4,4"/>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </Grid>
                                        
                                        <!-- Edit view -->
                                        <StackPanel Visibility="{Binding IsEditing, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <StackPanel Margin="0,0,0,16">
                                                <TextBlock Text="Name" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                          Margin="0,0,0,6"/>
                                                <ui:TextBox Text="{Binding Name, UpdateSourceTrigger=PropertyChanged}"/>
                                            </StackPanel>
                                            <StackPanel Margin="0,0,0,16">
                                                <TextBlock Text="Description" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                          Margin="0,0,0,6"/>
                                                <ui:TextBox Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}"/>
                                            </StackPanel>
                                            <StackPanel Margin="0,0,0,16">
                                                <TextBlock Text="ID" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                          Margin="0,0,0,6"/>
                                                <ui:TextBox Text="{Binding Id, UpdateSourceTrigger=PropertyChanged}"/>
                                                <TextBlock Text="Must be globally unique. Examples: plan.sys.full_test; plan.hw.comprehensive" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                          Margin="0,4,0,0"
                                                          TextWrapping="Wrap"/>
                                            </StackPanel>
                                            <StackPanel Margin="0,0,0,16">
                                                <TextBlock Text="Version" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                          Margin="0,0,0,6"/>
                                                <ui:TextBox Text="{Binding Version, UpdateSourceTrigger=PropertyChanged}"/>
                                            </StackPanel>
                                            <StackPanel>
                                                <TextBlock Text="Tags (comma-separated)" 
                                                          FontSize="{StaticResource FontSizeXS}"
                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                          Margin="0,0,0,6"/>
                                                <ui:TextBox Text="{Binding TagsText, UpdateSourceTrigger=PropertyChanged}"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </StackPanel>
                                </ui:CardExpander>
                                
                                <!-- Execution Flow -->
                                <ui:CardExpander IsExpanded="True" Margin="0,0,0,16">
                                    <ui:CardExpander.Header>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                                <TextBlock Text="Execution Flow" VerticalAlignment="Center"/>
                                                <!-- Update Available Indicator -->
                                                <Border Background="Transparent" 
                                                       BorderBrush="Transparent"
                                                       BorderThickness="0"
                                                       Padding="7,3"
                                                       Margin="10,0,0,0"
                                                       Visibility="{Binding HasUpdatableSuites, Converter={StaticResource BoolToVisibilityConverter}}">
                                                    <StackPanel Orientation="Horizontal">
                                                        <ui:SymbolIcon Symbol="ArrowSync24"
                                                                      FontSize="11"
                                                                      Foreground="#6B9080"
                                                                      Margin="0,0,5,0"/>
                                                        <TextBlock FontSize="11" 
                                                                  FontWeight="Normal"
                                                                  Foreground="{DynamicResource TextSecondaryBrush}">
                                                            <Run Text="{Binding UpdatableSuitesCount, Mode=OneWay}"/>
                                                            <Run Text="update(s) available"/>
                                                        </TextBlock>
                                                    </StackPanel>
                                                </Border>
                                            </StackPanel>
                                            <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="16,0,32,0">
                                                <!-- Update All Button -->
                                                <ui:Button Content="Update All" 
                                                          Icon="{ui:SymbolIcon ArrowSync24}" 
                                                          Command="{Binding UpdateAllSuiteReferencesCommand}"
                                                          Visibility="{Binding HasUpdatableSuites, Converter={StaticResource BoolToVisibilityConverter}}"
                                                          Appearance="Primary"
                                                          ToolTip="Update all test suites to latest versions"
                                                          Margin="0,0,16,0"/>
                                                <Separator Width="1" 
                                                          Background="{DynamicResource BorderSubtleBrush}"
                                                          Margin="0,4"
                                                          Visibility="{Binding HasUpdatableSuites, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                <ui:Button Icon="{ui:SymbolIcon ArrowUp24}" 
                                                          Command="{Binding MoveSuiteReferenceUpCommand}"
                                                          ToolTip="Move Up"
                                                          IsEnabled="{Binding IsEditing}"
                                                          Margin="16,0,8,0"/>
                                                <ui:Button Icon="{ui:SymbolIcon ArrowDown24}" 
                                                          Command="{Binding MoveSuiteReferenceDownCommand}"
                                                          ToolTip="Move Down"
                                                          IsEnabled="{Binding IsEditing}"
                                                          Margin="0,0,8,0"/>
                                                <ui:Button Content="Remove" 
                                                          Icon="{ui:SymbolIcon Delete24}" 
                                                          Command="{Binding RemoveSuiteReferenceCommand}"
                                                          IsEnabled="{Binding IsEditing}"
                                                          Margin="0,0,8,0"/>
                                                <ui:Button Content="Add Suite" 
                                                          Icon="{ui:SymbolIcon Add24}" 
                                                          Command="{Binding AddSuiteReferenceCommand}"
                                                          IsEnabled="{Binding IsEditing}"
                                                          Appearance="Primary"/>
                                            </StackPanel>
                                        </Grid>
                                    </ui:CardExpander.Header>
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="240"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        
                                        <!-- Execution Flow List -->
                                        <Border Grid.Row="0"
                                               Background="{DynamicResource ControlBackgroundSecondaryBrush}"
                                               BorderBrush="{DynamicResource BorderSubtleBrush}"
                                               BorderThickness="1"
                                               CornerRadius="8">
                                            <ListBox ItemsSource="{Binding SuiteReferences}"
                                                    SelectedItem="{Binding SelectedSuiteReference}"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Padding="4">
                                                <ListBox.ItemContainerStyle>
                                                    <Style TargetType="ListBoxItem">
                                                        <Setter Property="Padding" Value="12,10"/>
                                                        <Setter Property="Margin" Value="0,0,0,2"/>
                                                        <Setter Property="Background" Value="Transparent"/>
                                                        <Setter Property="BorderThickness" Value="0"/>
                                                        <Setter Property="Template">
                                                            <Setter.Value>
                                                                <ControlTemplate TargetType="ListBoxItem">
                                                                    <Border Background="{TemplateBinding Background}"
                                                                           BorderBrush="{TemplateBinding BorderBrush}"
                                                                           BorderThickness="{TemplateBinding BorderThickness}"
                                                                           Padding="{TemplateBinding Padding}"
                                                                           CornerRadius="6">
                                                                        <ContentPresenter/>
                                                                    </Border>
                                                                </ControlTemplate>
                                                            </Setter.Value>
                                                        </Setter>
                                                        <Style.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Background" Value="{DynamicResource InteractiveHoverBrush}"/>
                                                            </Trigger>
                                                            <Trigger Property="IsSelected" Value="True">
                                                                <Setter Property="Background" Value="{DynamicResource InteractiveSelectedBrush}"/>
                                                            </Trigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ListBox.ItemContainerStyle>
                                                <ListBox.ItemTemplate>
                                                    <DataTemplate>
                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="Auto"/>
                                                                <ColumnDefinition Width="*"/>
                                                                <ColumnDefinition Width="Auto"/>
                                                            </Grid.ColumnDefinitions>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                            </Grid.RowDefinitions>
                                                            
                                                            <Ellipse Grid.Column="0" Grid.Row="0"
                                                                    Width="6" Height="6"
                                                                    Fill="{StaticResource BrandPrimaryBrush}"
                                                                    VerticalAlignment="Center"
                                                                    Margin="0,0,10,0"/>
                                                            
                                                            <StackPanel Grid.Column="1" Grid.Row="0" Orientation="Horizontal" VerticalAlignment="Center">
                                                                <TextBlock Text="{Binding Name}" 
                                                                          FontSize="{StaticResource FontSizeM}"
                                                                          FontWeight="{StaticResource FontWeightSemiBold}"
                                                                          Foreground="{DynamicResource TextPrimaryBrush}"
                                                                          VerticalAlignment="Center"
                                                                          TextTrimming="CharacterEllipsis"/>
                                                                <ui:SymbolIcon Symbol="Shield24"
                                                                              Foreground="#2F6FED"
                                                                              Filled="True"
                                                                              ToolTip="Administrator required"
                                                                              Margin="6,0,0,0"
                                                                              VerticalAlignment="Center"
                                                                              Visibility="{Binding IsAdminRequired, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                                <ui:SymbolIcon Symbol="Shield24"
                                                                              Foreground="#2F6FED"
                                                                              ToolTip="Administrator recommended"
                                                                              Margin="6,0,0,0"
                                                                              VerticalAlignment="Center"
                                                                              Visibility="{Binding IsAdminPreferred, Converter={StaticResource BoolToVisibilityConverter}}"/>
                                                                <!-- Update Available Chip -->
                                                                <Border Background="Transparent" 
                                                                       BorderBrush="Transparent"
                                                                       BorderThickness="0"
                                                                       Padding="0"
                                                                       Margin="8,0,0,0"
                                                                       VerticalAlignment="Center"
                                                                       Visibility="{Binding HasUpdate, Converter={StaticResource BoolToVisibilityConverter}}">
                                                                    <StackPanel Orientation="Horizontal">
                                                                        <ui:SymbolIcon Symbol="ArrowCircleUp20"
                                                                                      FontSize="12"
                                                                                      Foreground="#5B8FA3"
                                                                                      Margin="0,0,4,0"
                                                                                      VerticalAlignment="Center"/>
                                                                        <TextBlock FontSize="10.5" 
                                                                                  FontWeight="Normal"
                                                                                  Foreground="{DynamicResource TextSecondaryBrush}"
                                                                                  VerticalAlignment="Center"
                                                                                  Text="{Binding LatestVersion, StringFormat='v{0} available'}"/>
                                                                    </StackPanel>
                                                                </Border>
                                                            </StackPanel>
                                                            
                                                            <!-- Update Button -->
                                                            <ui:Button Grid.Row="0" Grid.Column="2"
                                                                      Content="Update"
                                                                      Icon="{ui:SymbolIcon ArrowSync20}"
                                                                      FontSize="11"
                                                                      Padding="8,2"
                                                                      Margin="8,0,0,0"
                                                                      Command="{Binding DataContext.UpdateSuiteReferenceCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                                                      CommandParameter="{Binding}"
                                                                      Visibility="{Binding HasUpdate, Converter={StaticResource BoolToVisibilityConverter}}"
                                                                      ToolTip="Update to latest version"/>
                                                            
                                                            <StackPanel Grid.Column="1" Grid.Row="1" Grid.ColumnSpan="2" Orientation="Horizontal" Margin="0,2,0,0">
                                                                <TextBlock FontSize="{StaticResource FontSizeXS}"
                                                                          Foreground="{DynamicResource TextSecondaryBrush}"
                                                                          TextTrimming="CharacterEllipsis">
                                                                    <Run Text="{Binding Id, Mode=OneWay}"/>
                                                                </TextBlock>
                                                                <TextBlock Text="    [ " 
                                                                          FontSize="{StaticResource FontSizeXS}"
                                                                          Foreground="{DynamicResource TextTertiaryBrush}"
                                                                          Margin="8,0,0,0"/>
                                                                <TextBlock FontSize="{StaticResource FontSizeXS}"
                                                                          Foreground="{DynamicResource TextTertiaryBrush}">
                                                                    <Run Text="{Binding CaseCount, Mode=OneWay}"/>
                                                                    <Run Text=" cases ]"/>
                                                                </TextBlock>
                                                            </StackPanel>
                                                        </Grid>
                                                    </DataTemplate>
                                                </ListBox.ItemTemplate>
                                            </ListBox>
                                        </Border>
                                        
                                        <!-- Suite Node Settings Panel -->
                                        <Border Grid.Row="1"
                                               Background="{DynamicResource ControlBackgroundSecondaryBrush}"
                                               BorderBrush="{DynamicResource BorderSubtleBrush}"
                                               BorderThickness="1"
                                               CornerRadius="8"
                                               Margin="0,12,0,0"
                                               Padding="16,12"
                                               Visibility="{Binding SelectedSuiteReference, Converter={StaticResource NullToVisibilityConverter}}"
                                               IsEnabled="{Binding IsEditing}">
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>
                                                
                                                <!-- Header -->
                                                <TextBlock Grid.Row="0" 
                                                          Text="Suite Node Settings" 
                                                          FontSize="{StaticResource FontSizeS}"
                                                          FontWeight="{StaticResource FontWeightSemiBold}"
                                                          Foreground="{DynamicResource TextSecondaryBrush}"
                                                          Margin="0,0,0,12"/>
                                                
                                                <!-- Reference Name -->
                                                <StackPanel Grid.Row="1" Margin="0,0,0,12">
                                                    <TextBlock Text="Reference Name" 
                                                              FontSize="{StaticResource FontSizeXS}"
                                                              Foreground="{DynamicResource TextTertiaryBrush}"
                                                              Margin="0,0,0,4"/>
                                                    <ui:TextBox Text="{Binding SelectedSuiteReference.Ref, UpdateSourceTrigger=PropertyChanged}"
                                                               PlaceholderText="Display name for this suite instance"/>
                                                </StackPanel>
                                                
                                                <!-- Controls Override -->
                                                <StackPanel Grid.Row="2">
                                                    <TextBlock Text="Execution Controls Override" 
                                                              FontSize="{StaticResource FontSizeXS}"
                                                              Foreground="{DynamicResource TextTertiaryBrush}"
                                                              Margin="0,0,0,8"/>
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="*"/>
                                                        </Grid.ColumnDefinitions>
                                                        
                                                        <!-- Repeat -->
                                                        <StackPanel Grid.Column="0" Margin="0,0,8,0">
                                                            <TextBlock Text="Repeat" 
                                                                      FontSize="{StaticResource FontSizeXS}"
                                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                                      Margin="0,0,0,4"/>
                                                            <ui:NumberBox Value="{Binding SelectedSuiteReference.Repeat, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                                         Minimum="1"
                                                                         Maximum="100"
                                                                         SpinButtonPlacementMode="Compact"/>
                                                        </StackPanel>
                                                        
                                                        <!-- Retry on Error -->
                                                        <StackPanel Grid.Column="1" Margin="0,0,8,0">
                                                            <TextBlock Text="Retry on Error" 
                                                                      FontSize="{StaticResource FontSizeXS}"
                                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                                      Margin="0,0,0,4"/>
                                                            <ui:NumberBox Value="{Binding SelectedSuiteReference.RetryOnError, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                                         Minimum="0"
                                                                         Maximum="10"
                                                                         SpinButtonPlacementMode="Compact"/>
                                                        </StackPanel>
                                                        
                                                        <!-- Max Parallel (hidden - not implemented) -->
                                                        <StackPanel Grid.Column="2" Margin="0,0,8,0" Visibility="Collapsed">
                                                            <TextBlock Text="Max Parallel" 
                                                                      FontSize="{StaticResource FontSizeXS}"
                                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                                      Margin="0,0,0,4"/>
                                                            <ui:NumberBox Value="{Binding SelectedSuiteReference.MaxParallel, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                                         Minimum="1"
                                                                         Maximum="32"
                                                                         SpinButtonPlacementMode="Compact"/>
                                                        </StackPanel>
                                                        
                                                        <!-- Continue on Failure -->
                                                        <StackPanel Grid.Column="2">
                                                            <TextBlock Text="Continue on Failure" 
                                                                      FontSize="{StaticResource FontSizeXS}"
                                                                      Foreground="{DynamicResource TextTertiaryBrush}"
                                                                      Margin="0,0,0,4"/>
                                                            <ui:ToggleSwitch IsChecked="{Binding SelectedSuiteReference.ContinueOnFailure, Mode=TwoWay}"
                                                                            OnContent="Yes"
                                                                            OffContent="No"/>
                                                        </StackPanel>
                                                    </Grid>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </Grid>
                                </ui:CardExpander>
                                
                                <!-- Environment -->
                                <ui:CardExpander IsExpanded="False" Margin="0,0,0,16">
                                    <ui:CardExpander.Header>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0" Text="Environment Variables" VerticalAlignment="Center"/>
                                            <ui:Button Grid.Column="1" 
                                                      Content="Add"
                                                      Icon="{ui:SymbolIcon Add24}"
                                                      Command="{Binding EnvironmentEditor.AddRowCommand}"
                                                      IsEnabled="{Binding IsEditing}"
                                                      Appearance="Primary"
                                                      Margin="16,0,32,0"/>
                                        </Grid>
                                    </ui:CardExpander.Header>
                                    <Grid IsEnabled="{Binding IsEditing}">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="280"/>
                                        </Grid.RowDefinitions>

                                        <!-- Environment Editor Control -->
                                        <ContentControl Grid.Row="0"
                                                       Content="{Binding EnvironmentEditor}"
                                                       HorizontalAlignment="Stretch"
                                                       VerticalAlignment="Stretch">
                                            <ContentControl.ContentTemplate>
                                                <DataTemplate>
                                                    <local:EnvVarEditor/>
                                                </DataTemplate>
                                            </ContentControl.ContentTemplate>
                                        </ContentControl>
                                    </Grid>
                                </ui:CardExpander>
                                </StackPanel>
                            </ScrollViewer>
                        </Grid>
                    </Border>
                </Grid>
            </TabItem>
        </TabControl>
        
        <!-- Busy overlay -->
        <Border Background="{DynamicResource OverlayBackgroundBrush}" Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ui:ProgressRing IsIndeterminate="True"/>
                <TextBlock Text="{Binding BusyMessage}" Margin="0,10,0,0" Foreground="{DynamicResource TextOnDarkBrush}"/>
            </StackPanel>
        </Border>
    </Grid>
</Page>
